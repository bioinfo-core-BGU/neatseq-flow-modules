Global_params:
    Default_wait: 10
    Qsub_opts: -V -cwd
    Qsub_path: /path/to/qsub/bin
    Qsub_q: queue.q
    module_path:      ../neatseq_flow_modules
    
    
Description: |
    A pipeline for basic RNA-seq analysis using Trinity
    ---------------------------------------------------
    
    This workflow takes reads in fastq format, either paired-end or single, performs quality testing with FastQC and trimming with trimmomatic, and assembles the trascriptome with Trinity.
    
    It then runs `align_and_estimate_abundance.pl` and `abundance_estimates_to_matrix.pl` to map the reads to the trascriptome and create normalized counts tables. These tables can then be used in DEseq2 or other tools for statistical analysis of RNA-seq data.
    
    Finally, the workflow includes the Trinotate pipeline for annotating the assembly.
    
    Steps:
    ------
    
    1. Concatenating the read files into single files per direction
    2. Adding tags required by trinity to the read titles (/1 and /2 for F and R. See https://github.com/trinityrnaseq/trinityrnaseq/wiki/Running-Trinity)
    3. Running Trinity. Trinity must be configured to run on a cluster. The configuration file is passed with --grid_conf. THIS STEP CAN TAKE A LONG TIME TO RUN!
    4. Mapping of the reads is performed with trinity_mapping module
    5. Creating statistical tables is performed with trinmap_statistics module.
    6. Annotation with trinotate
    
Vars:
    paths:
        multiqc:            /path/to/multiqc
        bowtie2:            /path/to/bowtie2_v2.2.5         # Path to the dir which includes bowtie2 and bowtie2-build executables
        Trinity:            /path/to/trinity/               # Path to the dir which contains Trinity executable and a dir util/ with the toolkit scripts
        SGE_Trinity_conf:   /path/to/cluster_Trinity_conf.txt  # Path to file with cluster configuration for trinity. See --grid_conf parameter in trinity manual.
        RSEM:               /path/to/rsem/bin               # Path to dir containing rsem scripts 
        samtools:           /path/to/samtools-1.3/bin       # Path to dir containing samtools executable
        STAR:               /path/to/STAR                   # Path to STAR executable
        # bowtie2:            /path/to/bowtie2/
        # samtools:           /path/to/samtools
        hpc_cmds_GridRunner:    /path/to/hpc_cmds_GridRunner.pl
        BUSCO:              /path/to/BUSCO.py
        filter_trinity_by_counts:   /path/to/filter_trinity_by_counts.R
# -------- Trinotate
        TransDecoder:       /path/to/Trinity/TransDecoder-v5.0.2/TransDecoder
        Trinotate:          /path/to/Trinity/Trinotate-v3.1.1/Trinotate    
        hmmscan:            /path/to/HMMER/HMMER_v3.1b1/bin/hmmscan
        hmm:                /path/to/HMMER/HMMER_v3.1b1/bin
        blast:              /path/to/BLAST/ncbi-blast-2.7.1+/bin
        blastp:             /path/to/BLAST/ncbi-blast-2.7.1+/bin/blastp
        blastn:             /path/to/BLAST/ncbi-blast-2.7.1+/bin/blastn        
    databases:
        BUSCO:              /path/to/BUSCO/dataset
        trinotate:
            sprot:          /gpfs0/bioinfo/databases/Trinity/Trinotate_v3.1.1/uniprot_sprot_blastdb/sprot
            pfam:           /gpfs0/bioinfo/databases/Trinity/Trinotate_v3.1.1/PFAM/Pfam-A.hmm
            sqlitedb:       /gpfs0/bioinfo/databases/Trinity/Trinotate_v3.1.1/Trinotate.sqlite        
    cluster_params:
        pe:                 shared

Step_params:
    # -------------------- Part 1: Merging and QC
    # Copy and concatenate files into data directory:
    Merge:
        module:             merge
        script_path:
        tag:                qc
    # FastQC on the files
    fqc_merge1:
        module:         fastqc_html
        base:           merge1
        script_path:    {Vars.paths.fastqc}
        qsub_params:
            -pe:        '{Vars.cluster_params.pe} 15'
        redirects:
            --threads:  15
    # Trim with trimmomatic if required
    trim1:
        module:         trimmo
        base:           merge1
        script_path:    '{Vars.paths.java} -jar {Vars.paths.trimmo}'
        qsub_params:
            -pe:        '{Vars.cluster_params.pe} 20'
#        spec_dir: 
        todo:           LEADING:20 TRAILING:20
        redirects:
            -threads:   20
    # FastQC on the trimmed files
    fqc_trim1:
        module:         fastqc_html
        base:           trim1
        script_path:    {Vars.paths.fastqc}
        qsub_params:
            -pe:        '{Vars.cluster_params.pe}  15'
        redirects:
            --threads:  15
    # Summary of file quality before and after trimming
    multiqc_sum:
        module:         Multiqc
        base:
            - fqc_trim1
            - fqc_merge1
        script_path:    {Vars.paths.multiqc}
            
    # -------------------- Part 2: Assembly and statisctical analysis
    # Add trinity tags to reads
    Trinity_tags:
        module:             add_trinity_tags
        base:               Merge
        script_path: 
        tag:                Trinity
    # Assemble the reads with Trinity. THIS STEP CAN TAKE A LONG TIME!
    Trinity_assembl:
        module:             trinity_new
        base:               Trinity_tags
        script_path:        '{Vars.paths.Trinity}/Trinity'
        qsub_params:
            -pe:            '{Vars.cluster_params.pe} 20'
        scope:              project
        redirects:
            --grid_exec:        '"{Vars.paths.hpc_cmds_GridRunner} --grid_conf {Vars.paths.SGE_Trinity_conf} -c"'
            --seqType:          fq
            --min_kmer_cov:     2
            # --full_cleanup:
    # Create transcript-gene map
    Get_Trans_Map:
        module:             Trinity_gene_to_trans_map
        base:               Trinity_assembl
        script_path:        '{Vars.paths.Trinity}/util/support_scripts/get_Trinity_gene_to_trans_map.pl'
        scope:              project
        # stop_and_show:

    # Map the reads to the assembly
    Trinity_Map:
        module:             trinity_mapping
        base:               Get_Trans_Map
        script_path:        '{Vars.paths.Trinity}/util/align_and_estimate_abundance.pl'
        sample_list:        [Sample1,Sample2]
        scope:              project
        setenv:             PATH "{Vars.paths.bowtie2}:{Vars.paths.RSEM}:{Vars.paths.samtools}:$PATH"
        redirects:
            --est_method:   rsem
            --aln_method:   bowtie
            # --output_prefix:        # Pass to add output_prefix. This is for older versions of trinity...
            --trinity_mode:
            --coordsort_bam:
            --seqType:      fq
    # Count reads per transcript with RSEM
    Trinity_Map_Stats:
        module:             trinmap_statistics
        base:               Trinity_Map
        script_path:        '{Vars.paths.Trinity}/util/abundance_estimates_to_matrix.pl'
        # use_isoforms:          # use isoforms results. Remove to use genes results
        scope:              project
        redirects:
            --est_method:   RSEM
            # --gene_trans_map:   
        # stop_and_show:

    # Keep the most highly expressed transcript per gene - Representative transcript
    Rep_transcript:                   # Name of this step
        module:             Generic             # Name of module
        base:               Trinity_Map_Stats
        script_path:        '{Vars.paths.Trinity}util/filter_low_expr_transcripts.pl'
        scope:              project
        shell:              bash
        inputs:                     # The inputs for this module
            --matrix:                    # Input argument, could be also 'empty#'
                scope:      project
                File_Type:  isoform.norm_counts
            --transcripts:
                scope:      project
                File_Type:  fasta.nucl
            --gene_to_trans_map:
                scope:      project
                File_Type:  gene_trans_map
        outputs:
            '>':
                File_Type:   fasta.nucl
                suffix:      .filter_low_expr.fasta       # A suffix for this output argument file name
        redirects:
            --highest_iso_only:

    # Quality test the assembly with BUSCO
    BUSCO1:
        module:             BUSCO
        base:               Rep_transcript
        script_path:        {Vars.paths.BUSCO} 
        scope:              project
        redirects:
            --mode:         transcriptome
            --lineage:      {Vars.databases.BUSCO}
            --cpu:          20
            --force:
            --restart:
        qsub_params:
            -pe:            '{Vars.cluster_params.pe} 20'
            

# -------------------- Part 2: Annotate with Trinotate:

    # Splitting into 4 parts, for parallelization. Increase number for faster analysis. 
    Split_Fasta:
        module:             split_fasta
        base:               Trinity_assembl
        script_path:
        tag:                trinotate
        scope:              project
        type:               nucl
        subsample_num:      4

    Trino_blastx_sprot:
        module:             blast_new
        base:               Split_Fasta
        script_path:        '{Vars.paths.blast}/blastx'
        query:              sample
        db:                 {Vars.databases.trinotate.sprot}
        querytype:          nucl
        redirects:
            -max_target_seqs: 1
            -num_threads:   1
            -outfmt:        6
    Trino_Transdecode:
        module:             TransDecoder
        base:               Split_Fasta
        script_path:        "{Vars.paths.TransDecoder}.LongOrfs"
        scope:              sample
    Trino_blastp_sprot:
        module:             blast_new
        base:               Trino_Transdecode
        script_path:        {Vars.paths.blastp}
        query:              sample
        db:                 {Vars.databases.trinotate.sprot}
        querytype:          prot
        redirects:
            -max_target_seqs: 1
            -num_threads:   1
            -outfmt:        6
    Trino_hmmscan1:
        module:             hmmscan
        base:               Trino_Transdecode
        script_path:        {Vars.paths.hmmscan}
        scope:              sample
        type:               prot
        output_type:        domtblout  # one of tblout (parseable table of per-sequence hits to file), domtblout (parseable table of per-domain hits to file) and pfamtblout (table of hits and domains in Pfam format)
        hmmdb:              {Vars.databases.trinotate.pfam}
        qsub_params:
            -q:             bioinfo.q
        redirects:
            --cpu:          1

    Trino_rnammer:
        module:             RnammerTranscriptome
        base:               Split_Fasta
        script_path:        /gpfs0/bioinfo/apps/Trinity/Trinotate-v3.1.1/util/rnammer_support/RnammerTranscriptome.pl #{Vars.paths.hmmscan}
        scope:              sample
        redirects:
            --path_to_rnammer:  /gpfs0/bioinfo/apps/RNAMMER/RNAMMER_v1.2/rnammer
    
    Trino_Transdecode_Predict:
        module:             TransDecoder
        base:               
            - Trino_Transdecode
            - Trino_blastp_sprot
            - Trino_hmmscan1
        script_path:        "{Vars.paths.TransDecoder}.Predict"
        scope:              sample
        redirects:
            --single_best_only:
        # Predict:

    Trino_merge_tables:
        module:             merge_table
        base:               [Trino_blastp_sprot,Trino_blastx_sprot,Trino_rnammer,Trino_hmmscan1]
        script_path:        
        type:               [blast.prot,blast.nucl,transcripts.fasta.nucl,fasta.prot,rnammer,hmmscan.prot]
        header:             [0,0,0,0,0,5]
        ext:                [out, out, fna, faa, out, hmm.out]
        # stop_and_show:

    Trino_Trinotate1:
        module:             Trinotate
        base:               
            - Trino_merge_tables
            - Get_Trans_Map
        script_path:        {Vars.paths.Trinotate}
        scope:              project
        sqlitedb:           {Vars.databases.trinotate.sqlitedb}
        cp_sqlitedb:        



#####################################################
# Project-wide decoder with Predict
    Trino_Transdecode_proj:
        module:             TransDecoder
        base:               Trinity_assembl
        script_path:        "{Vars.paths.TransDecoder}.LongOrfs"
        scope:              project
    Trino_blastp_sprot_proj:
        module:             blast_new
        base:               Trino_Transdecode_proj
        script_path:        {Vars.paths.blastp}
        query:              project
        db:            {Vars.databases.trinotate.sprot}
        querytype:          prot
        redirects:
            -max_target_seqs: 1
            -num_threads:   1
            -outfmt:        6
    Trino_hmmscan1_proj:
        module:             hmmscan
        base:               Trino_Transdecode_proj
        script_path:        {Vars.paths.hmmscan}
        scope:              project
        type:               prot
        output_type:        domtblout  # one of tblout (parseable table of per-sequence hits to file), domtblout (parseable table of per-domain hits to file) and pfamtblout (table of hits and domains in Pfam format)
        hmmdb:              {Vars.databases.trinotate.pfam}
        qsub_params:
            -q:             bioinfo.q
        redirects:
            --cpu:          1

    
    Trino_Transdecode_Predict_proj:
        module:             TransDecoder
        base:               
            - Trino_Transdecode_proj
            - Trino_blastp_sprot_proj
            - Trino_hmmscan1_proj
        script_path:        "{Vars.paths.TransDecoder}.Predict"
        scope:              project
        # keep_previous:
        redirects:
            --single_best_only:
        # Predict: